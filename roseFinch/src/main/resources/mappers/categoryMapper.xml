<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.web.rosefinch.mapper.categoryMapper">
	<resultMap id="categoryVO" type="com.web.rosefinch.category.vo.CategoryVO">
		<result property="catCode" column="CAT_CODE"/>
		<result property="catParCode" column="CAT_PAR_CODE"/>
		<result property="catName" column="CAT_NAME"/>
	</resultMap>
	
	<!-- 자손 카테고리 조회 -->
	<select id="getSubCategories" resultMap="categoryVO" parameterType="com.web.rosefinch.goods.vo.FilterVO">
		select 	cat_code,
				cat_par_code,
				cat_name
		from	category
		where	cat_par_code = #{catCode};
	</select>
	
	<!-- 필터가 적용된 자손 카테고리 조회 -->
	<select id="getCategoryFilter" resultMap="categoryVO" parameterType="com.web.rosefinch.goods.vo.FilterVO">
		SELECT	cat_code,
				cat_name,
				cat_par_code
		FROM 	category
		WHERE 	cat_par_code = #{catCode}
				AND cat_code IN (
					#재귀과정을 통해서, 카테고리들의 최고 상위 카테고리를 조회 (결과 중복X)
					WITH recursive cte (cat_code, cat_name, cat_par_code) as
					(
						SELECT 	cat_code,
								cat_name,
								cat_par_code
						FROM	category 
						WHERE	cat_code IN
									(
										#겸색된 상품들의 카테고리번호 조회
										SELECT DISTINCT 
												node.cat_code
										FROM	category AS node,
												goods AS goods
										WHERE	node.cat_code = goods.cat_code
												AND goods.gds_name LIKE CONCAT('%', #{keyword}, '%')
									)
						UNION
						SELECT	p.cat_code,
								p.cat_name,
								p.cat_par_code
						FROM	category p
						INNER JOIN cte ON p.cat_code = cte.cat_par_code
					)
					SELECT cat_code FROM cte
		)
	</select>
</mapper>